# å¯¹è±¡å­˜å‚¨æœåŠ¡ (OSS) é›†æˆæŒ‡å—

åŸºäº nest-admin é¡¹ç›®çš„æ–‡ä»¶å­˜å‚¨ä¸ç®¡ç†å®è·µ

## ğŸ“š ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [OSS é…ç½®](#oss-é…ç½®)
3. [æ–‡ä»¶ä¸Šä¼ ](#æ–‡ä»¶ä¸Šä¼ )
4. [æ–‡ä»¶ç®¡ç†](#æ–‡ä»¶ç®¡ç†)
5. [ä¸ƒç‰›äº‘å­˜å‚¨é›†æˆ](#ä¸ƒç‰›äº‘å­˜å‚¨é›†æˆ)
6. [æœ€ä½³å®è·µæ€»ç»“](#æœ€ä½³å®è·µæ€»ç»“)

## ğŸ’¡ æ¦‚è¿°

å¯¹è±¡å­˜å‚¨æœåŠ¡ (Object Storage Service, OSS) æ˜¯ä¸€ç§æµ·é‡ã€å®‰å…¨ã€ä½æˆæœ¬ã€é«˜å¯é çš„äº‘å­˜å‚¨æœåŠ¡ï¼Œå¸¸ç”¨äºå­˜å‚¨å›¾ç‰‡ã€è§†é¢‘ã€æ–‡æ¡£ç­‰éç»“æ„åŒ–æ•°æ®ã€‚`nest-admin` é¡¹ç›®é›†æˆäº†æ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†åŠŸèƒ½ï¼Œå¯ä»¥æ”¯æŒæœ¬åœ°å­˜å‚¨å’Œäº‘å­˜å‚¨ï¼ˆä¾‹å¦‚ä¸ƒç‰›äº‘ OSSï¼‰ï¼Œæ–¹ä¾¿ç”¨æˆ·å¯¹æ–‡ä»¶è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚

æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç» `nest-admin` é¡¹ç›®ä¸­ OSS çš„é…ç½®ã€æ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†æµç¨‹ï¼Œä»¥åŠä¸ƒç‰›äº‘å­˜å‚¨çš„é›†æˆæ–¹å¼ã€‚

## âš™ï¸ OSS é…ç½®

OSS çš„åŸºæœ¬é…ç½®ä¿¡æ¯ä½äº `src/config/oss.config.ts` æ–‡ä»¶ä¸­ã€‚è¿™äº›é…ç½®é¡¹å®šä¹‰äº†è®¿é—®å¯¹è±¡å­˜å‚¨æœåŠ¡æ‰€éœ€çš„å‡­è¯ã€åŸŸåå’Œå­˜å‚¨åŒºåŸŸç­‰ä¿¡æ¯ã€‚

```typescript
// src/config/oss.config.ts
import { ConfigType, registerAs } from '@nestjs/config'
import * as qiniu from 'qiniu'

import { env } from '~/global/env'

// è§£æä¸ƒç‰›äº‘å­˜å‚¨åŒºåŸŸ
function parseZone(zone: string) {
  switch (zone) {
    case 'Zone_as0':
      return qiniu.zone.Zone_as0
    case 'Zone_na0':
      return qiniu.zone.Zone_na0
    case 'Zone_z0':
      return qiniu.zone.Zone_z0
    case 'Zone_z1':
      return qiniu.zone.Zone_z1
    case 'Zone_z2':
      return qiniu.zone.Zone_z2
  }
}

export const ossRegToken = 'oss'

export const OssConfig = registerAs(ossRegToken, () => ({
  accessKey: env('OSS_ACCESSKEY'), // OSS è®¿é—®å¯†é’¥ AccessKey
  secretKey: env('OSS_SECRETKEY'), // OSS è®¿é—®å¯†é’¥ SecretKey
  domain: env('OSS_DOMAIN'), // OSS å­˜å‚¨æ¡¶çš„åŸŸå
  bucket: env('OSS_BUCKET'), // OSS å­˜å‚¨æ¡¶çš„åç§°
  zone: parseZone(env('OSS_ZONE') || 'Zone_z2'), // OSS å­˜å‚¨åŒºåŸŸï¼Œé»˜è®¤ä¸ºåå—åŒº (Zone_z2)
  access: (env('OSS_ACCESS_TYPE') as any) || 'public', // OSS è®¿é—®ç±»å‹ï¼Œé»˜è®¤ä¸ºå…¬å…±è¯»
}))

export type IOssConfig = ConfigType<typeof OssConfig>
```

**å…³é”®é…ç½®é¡¹ï¼š**

*   `accessKey` å’Œ `secretKey`ï¼šä½ çš„ OSS æœåŠ¡æä¾›å•†ï¼ˆå¦‚ä¸ƒç‰›äº‘ã€é˜¿é‡Œäº‘ OSSã€è…¾è®¯äº‘ COSï¼‰æä¾›çš„è®¿é—®å‡­è¯ã€‚è¿™äº›å‡­è¯æ˜¯è®¿é—® OSS çš„é’¥åŒ™ï¼Œåº”å¦¥å–„ä¿ç®¡ï¼Œåˆ‡å‹¿æ³„éœ²ã€‚
*   `domain`ï¼šä½ çš„ OSS å­˜å‚¨æ¡¶æ‰€ç»‘å®šçš„è‡ªå®šä¹‰åŸŸåæˆ– OSS æä¾›çš„é»˜è®¤åŸŸåã€‚é€šè¿‡æ­¤åŸŸåå¯ä»¥è®¿é—®å­˜å‚¨åœ¨ OSS ä¸­çš„æ–‡ä»¶ã€‚
*   `bucket`ï¼šä½ åˆ›å»ºçš„ OSS å­˜å‚¨æ¡¶çš„åç§°ã€‚æ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶éƒ½å°†å­˜å‚¨åœ¨è¿™ä¸ªå­˜å‚¨æ¡¶ä¸­ã€‚
*   `zone`ï¼šOSS å­˜å‚¨åŒºåŸŸã€‚å¯¹äºä¸ƒç‰›äº‘ï¼Œå®ƒæœ‰å¤šä¸ªåŒºåŸŸï¼ˆä¾‹å¦‚åä¸œã€åå—ã€ååŒ—ç­‰ï¼‰ï¼Œéœ€è¦æ ¹æ®ä½ çš„å­˜å‚¨æ¡¶æ‰€åœ¨åŒºåŸŸè¿›è¡Œé…ç½®ã€‚`parseZone` å‡½æ•°å°†ç¯å¢ƒå˜é‡ä¸­çš„åŒºåŸŸå­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸ƒç‰› SDK å¯¹åº”çš„åŒºåŸŸå¯¹è±¡ã€‚
*   `access`ï¼šå­˜å‚¨æ¡¶çš„è®¿é—®æƒé™ç±»å‹ï¼Œé€šå¸¸ä¸º `public`ï¼ˆå…¬å…±è¯»ï¼‰æˆ– `private`ï¼ˆç§æœ‰ï¼‰ã€‚

è¿™äº›é…ç½®é¡¹çš„å€¼é€šå¸¸ä» `.env` æ–‡ä»¶ä¸­è¯»å–ï¼Œä»¥ä¾¿åœ¨ä¸åŒç¯å¢ƒä¸­çµæ´»é…ç½®ã€‚

### OSS æ¨¡å—æ³¨å†Œ (`StorageModule` å’Œ `UploadModule`)

`nest-admin` é¡¹ç›®ä¸­ï¼Œæ–‡ä»¶å­˜å‚¨ç›¸å…³çš„åŠŸèƒ½ç”± `StorageModule` å’Œ `UploadModule` æä¾›ã€‚

*   `StorageModule` (`src/modules/tools/storage/storage.module.ts`)ï¼šè´Ÿè´£æ–‡ä»¶è®°å½•çš„æŒä¹…åŒ–ï¼ˆå­˜å‚¨åˆ°æ•°æ®åº“ï¼‰ï¼Œä»¥åŠæ–‡ä»¶çš„æŸ¥è¯¢å’Œåˆ é™¤æ“ä½œã€‚
*   `UploadModule` (`src/modules/tools/upload/upload.module.ts`)ï¼šè´Ÿè´£å¤„ç†æ–‡ä»¶çš„å®é™…ä¸Šä¼ é€»è¾‘ï¼ŒåŒ…æ‹¬æœ¬åœ°æ–‡ä»¶ä¿å­˜å’Œï¼ˆæœªæ¥å¯æ‰©å±•çš„ï¼‰OSS ä¸Šä¼ ã€‚

```typescript
// src/modules/tools/storage/storage.module.ts
import { Module } from '@nestjs/common'
import { TypeOrmModule } from '@nestjs/typeorm'

import { UserEntity } from '~/modules/user/user.entity'

import { StorageController } from './storage.controller'
import { Storage } from './storage.entity'
import { StorageService } from './storage.service'

const services = [StorageService]

@Module({
  imports: [TypeOrmModule.forFeature([Storage, UserEntity])], // æ³¨å†Œ Storage å®ä½“ï¼Œç”¨äºæ•°æ®åº“æ“ä½œ
  controllers: [StorageController],
  providers: [...services],
  exports: [TypeOrmModule, ...services],
})
export class StorageModule {}
```

```typescript
// src/modules/tools/upload/upload.module.ts
import { forwardRef, Module } from '@nestjs/common'

import { StorageModule } from '../storage/storage.module' // ä¾èµ– StorageModule

import { UploadController } from './upload.controller'
import { UploadService } from './upload.service'

const services = [UploadService]

@Module({
  imports: [forwardRef(() => StorageModule)], // ä½¿ç”¨ forwardRef è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜
  controllers: [UploadController],
  providers: [...services],
  exports: [...services],
})
export class UploadModule {}
```

## â¬†ï¸ æ–‡ä»¶ä¸Šä¼ 

`nest-admin` é¡¹ç›®é€šè¿‡ `UploadService` (`src/modules/tools/upload/upload.service.ts`) å¤„ç†æ–‡ä»¶çš„ä¸Šä¼ ã€‚ç›®å‰ï¼Œå®ƒä¸»è¦å®ç°äº†æœ¬åœ°æ–‡ä»¶çš„ä¿å­˜ã€‚

### 1. æ–‡ä»¶ä¸Šä¼ æœåŠ¡ (`UploadService`)

`UploadService` è´Ÿè´£æ¥æ”¶ä¸Šä¼ çš„æ–‡ä»¶æµï¼Œå°†å…¶ä¿å­˜åˆ°æŒ‡å®šç›®å½•ï¼Œå¹¶å°†æ–‡ä»¶ä¿¡æ¯è®°å½•åˆ°æ•°æ®åº“ä¸­ã€‚

```typescript
// src/modules/tools/upload/upload.service.ts
import { MultipartFile } from '@fastify/multipart'
import { Injectable, NotFoundException } from '@nestjs/common'
import { InjectRepository } from '@nestjs/typeorm'
import dayjs from 'dayjs'
import { isNil } from 'lodash'
import { Repository } from 'typeorm'

import { Storage } from '~/modules/tools/storage/storage.entity'

import {
  fileRename,
  getExtname,
  getFilePath,
  getFileType,
  getSize,
  saveLocalFile,
} from '~/utils/file.util'

@Injectable()
export class UploadService {
  constructor(
    @InjectRepository(Storage)
    private storageRepository: Repository<Storage>, // ç”¨äºä¿å­˜æ–‡ä»¶è®°å½•åˆ°æ•°æ®åº“
  ) {}

  /**
   * ä¿å­˜æ–‡ä»¶ä¸Šä¼ è®°å½• (ç›®å‰ä¸ºæœ¬åœ°å­˜å‚¨)
   * @param file ä¸Šä¼ çš„æ–‡ä»¶å¯¹è±¡
   * @param userId ä¸Šä¼ ç”¨æˆ·ID
   * @returns æ–‡ä»¶è·¯å¾„
   */
  async saveFile(file: MultipartFile, userId: number): Promise<string> {
    if (isNil(file))
      throw new NotFoundException('Have not any file to upload!')

    const fileName = file.filename // åŸå§‹æ–‡ä»¶å
    const size = getSize(file.file.bytesRead) // æ–‡ä»¶å¤§å°
    const extName = getExtname(fileName) // æ–‡ä»¶æ‰©å±•å
    const type = getFileType(extName) // æ–‡ä»¶ç±»å‹ (å¦‚ image, video)
    const name = fileRename(fileName) // é‡å‘½ååçš„æ–‡ä»¶å
    const currentDate = dayjs().format('YYYY-MM-DD') // å½“å‰æ—¥æœŸï¼Œç”¨äºæ„å»ºå­˜å‚¨è·¯å¾„
    const path = getFilePath(name, currentDate, type) // æ–‡ä»¶å­˜å‚¨è·¯å¾„

    // ä¿å­˜æœ¬åœ°æ–‡ä»¶
    saveLocalFile(await file.toBuffer(), name, currentDate, type)

    // å°†æ–‡ä»¶ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“
    await this.storageRepository.save({
      name,
      fileName,
      extName,
      path,
      type,
      size,
      userId,
    })

    return path
  }
}
```

**æ–‡ä»¶ä¸Šä¼ æµç¨‹ï¼š**

1.  **æ¥æ”¶æ–‡ä»¶**ï¼šé€šè¿‡ NestJS çš„æ–‡ä»¶ä¸Šä¼ èƒ½åŠ›ï¼ˆä¾‹å¦‚ `FastifyFileInterceptor`ï¼‰ï¼Œå°†ä¸Šä¼ çš„æ–‡ä»¶ä½œä¸º `MultipartFile` å¯¹è±¡æ¥æ”¶ã€‚
2.  **æ–‡ä»¶å¤„ç†**ï¼š`UploadService` ä¼šå¯¹æ–‡ä»¶åè¿›è¡Œé‡å‘½åï¼Œæå–æ–‡ä»¶æ‰©å±•åå’Œç±»å‹ï¼Œå¹¶è®¡ç®—æ–‡ä»¶å¤§å°ã€‚
3.  **æœ¬åœ°ä¿å­˜**ï¼šè°ƒç”¨ `saveLocalFile` å‡½æ•°å°†æ–‡ä»¶å†…å®¹ä¿å­˜åˆ°æœåŠ¡å™¨çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆé€šå¸¸æ˜¯ `public` ç›®å½•ä¸‹çš„æŒ‰æ—¥æœŸå’Œç±»å‹ç»„ç»‡çš„è·¯å¾„ï¼‰ã€‚
4.  **è®°å½•æ•°æ®åº“**ï¼šå°†æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆæ–‡ä»¶åã€è·¯å¾„ã€å¤§å°ã€ç±»å‹ã€ä¸Šä¼ ç”¨æˆ·ç­‰ï¼‰ä¿å­˜åˆ°æ•°æ®åº“çš„ `tool_storage` è¡¨ä¸­ã€‚

## ğŸ—„ï¸ æ–‡ä»¶ç®¡ç†

`StorageService` (`src/modules/tools/storage/storage.service.ts`) æä¾›äº†å¯¹å·²ä¸Šä¼ æ–‡ä»¶è¿›è¡ŒæŸ¥è¯¢å’Œåˆ é™¤çš„åŠŸèƒ½ã€‚

### 1. æ–‡ä»¶å­˜å‚¨å®ä½“ (`Storage`)

`Storage` å®ä½“ (`src/modules/tools/storage/storage.entity.ts`) å®šä¹‰äº†å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ–‡ä»¶è®°å½•ç»“æ„ã€‚

```typescript
// src/modules/tools/storage/storage.entity.ts
import { ApiProperty } from '@nestjs/swagger'
import { Column, Entity } from 'typeorm'

import { CommonEntity } from '~/common/entity/common.entity'

@Entity({ name: 'tool_storage' }) // æ•°æ®åº“è¡¨åä¸º tool_storage
export class Storage extends CommonEntity {
  @Column({ type: 'varchar', length: 200, comment: 'æ–‡ä»¶å' })
  @ApiProperty({ description: 'æ–‡ä»¶å' })
  name: string // å­˜å‚¨æ—¶çš„æ–‡ä»¶å (é‡å‘½åå)

  @Column({
    type: 'varchar',
    length: 200,
    nullable: true,
    comment: 'çœŸå®æ–‡ä»¶å',
  })
  @ApiProperty({ description: 'çœŸå®æ–‡ä»¶å' })
  fileName: string // åŸå§‹æ–‡ä»¶å

  @Column({ name: 'ext_name', type: 'varchar', nullable: true })
  @ApiProperty({ description: 'æ‰©å±•å' })
  extName: string // æ–‡ä»¶æ‰©å±•å

  @Column({ type: 'varchar' })
  @ApiProperty({ description: 'æ–‡ä»¶è·¯å¾„' })
  path: string // æ–‡ä»¶åœ¨æœåŠ¡å™¨ä¸Šçš„ç›¸å¯¹è·¯å¾„ (æˆ– OSS è·¯å¾„)

  @Column({ type: 'varchar', nullable: true })
  @ApiProperty({ description: 'æ–‡ä»¶ç±»å‹' })
  type: string // æ–‡ä»¶ç±»å‹ (å¦‚ image, audio, video, document)

  @Column({ type: 'varchar', nullable: true })
  @ApiProperty({ description: 'æ–‡ä»¶å¤§å°' })
  size: string // æ–‡ä»¶å¤§å° (æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼Œå¦‚ 1.2MB)

  @Column({ nullable: true, name: 'user_id' })
  @ApiProperty({ description: 'ç”¨æˆ·ID' })
  userId: number // ä¸Šä¼ ç”¨æˆ·ID
}
```

### 2. æ–‡ä»¶æŸ¥è¯¢ (`StorageService.list`)

`StorageService.list` æ–¹æ³•æ”¯æŒåˆ†é¡µå’Œå¤šç§æ¡ä»¶æŸ¥è¯¢ï¼Œæ–¹ä¾¿ç®¡ç†ç«¯å±•ç¤ºå’Œç­›é€‰æ–‡ä»¶ã€‚

```typescript
// src/modules/tools/storage/storage.service.ts
// ... existing code ...
  async list({
    page,
    pageSize,
    name,
    type,
    size,
    extName,
    time,
    username,
  }: StoragePageDto): Promise<Pagination<StorageInfo>> {
    const queryBuilder = this.storageRepository
      .createQueryBuilder('storage')
      .leftJoinAndSelect('sys_user', 'user', 'storage.user_id = user.id') // å…³è”ç”¨æˆ·è¡¨ä»¥è·å–ä¸Šä¼ è€…ä¿¡æ¯
      .where({
        ...(name && { name: Like(`%${name}%`) }),     // æ ¹æ®æ–‡ä»¶åæ¨¡ç³ŠæŸ¥è¯¢
        ...(type && { type }),                         // æ ¹æ®æ–‡ä»¶ç±»å‹æŸ¥è¯¢
        ...(extName && { extName }),                     // æ ¹æ®æ‰©å±•åæŸ¥è¯¢
        ...(size && { size: Between(size[0], size[1]) }), // æ ¹æ®æ–‡ä»¶å¤§å°èŒƒå›´æŸ¥è¯¢
        ...(time && { createdAt: Between(time[0], time[1]) }), // æ ¹æ®ä¸Šä¼ æ—¶é—´èŒƒå›´æŸ¥è¯¢
        ...(username && {                                // æ ¹æ®ä¸Šä¼ è€…ç”¨æˆ·åæŸ¥è¯¢
          userId: await (await this.userRepository.findOneBy({ username })).id,
        }),
      })
      .orderBy('storage.created_at', 'DESC') // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—

    const { items, ...rest } = await paginateRaw<Storage>(queryBuilder, {
      page,
      pageSize,
      paginationType: PaginationTypeEnum.LIMIT_AND_OFFSET,
    })

    // æ ¼å¼åŒ–æŸ¥è¯¢ç»“æœ
    function formatResult(result: Storage[]) {
      return result.map((e: any) => {
        return {
          id: e.storage_id,
          name: e.storage_name,
          extName: e.storage_ext_name,
          path: e.storage_path,
          type: e.storage_type,
          size: e.storage_size,
          createdAt: e.storage_created_at,
          username: e.user_username,
        }
      })
    }

    return {
      items: formatResult(items),
      ...rest,
    }
  }
// ... existing code ...
```

### 3. æ–‡ä»¶åˆ é™¤ (`StorageService.delete`)

`StorageService.delete` æ–¹æ³•æ”¯æŒæ‰¹é‡åˆ é™¤æ–‡ä»¶ï¼Œå¹¶ä¸”ä¼šåŒæ—¶åˆ é™¤æ•°æ®åº“è®°å½•å’Œæœ¬åœ°æ–‡ä»¶ã€‚

```typescript
// src/modules/tools/storage/storage.service.ts
// ... existing code ...
  /**
   * åˆ é™¤æ–‡ä»¶
   * @param fileIds æ–‡ä»¶IDæ•°ç»„
   */
  async delete(fileIds: number[]): Promise<void> {
    const items = await this.storageRepository.findByIds(fileIds) // æŸ¥è¯¢è¦åˆ é™¤çš„æ–‡ä»¶è®°å½•
    await this.storageRepository.delete(fileIds) // ä»æ•°æ®åº“åˆ é™¤è®°å½•

    // åˆ é™¤æœ¬åœ°æ–‡ä»¶
    items.forEach((el) => {
      deleteFile(el.path) // è°ƒç”¨æ–‡ä»¶å·¥å…·å‡½æ•°åˆ é™¤å®é™…æ–‡ä»¶
    })
  }
// ... existing code ...
```

## â˜ï¸ ä¸ƒç‰›äº‘å­˜å‚¨é›†æˆ

`nest-admin` é¡¹ç›®é€šè¿‡ `NetDiskManageService` (`src/modules/netdisk/manager/manage.service.ts`) é›†æˆäº†ä¸ƒç‰›äº‘å­˜å‚¨ï¼Œæä¾›äº†æ›´é«˜çº§çš„äº‘å­˜å‚¨æ–‡ä»¶ç®¡ç†åŠŸèƒ½ã€‚

### 1. ä¸ƒç‰›äº‘é…ç½®

ä¸ƒç‰›äº‘çš„é…ç½®ä½¿ç”¨äº† `oss.config.ts` ä¸­çš„ `accessKey`ã€`secretKey`ã€`domain`ã€`bucket` å’Œ `zone`ã€‚è¿™äº›é…ç½®åœ¨ `NetDiskManageService` çš„æ„é€ å‡½æ•°ä¸­è¢«ç”¨æ¥åˆå§‹åŒ–ä¸ƒç‰› SDKã€‚

```typescript
// src/modules/netdisk/manager/manage.service.ts
import { Inject, Injectable } from '@nestjs/common'
// ... å…¶ä»–å¯¼å…¥
import * as qiniu from 'qiniu'
import { auth, conf, rs } from 'qiniu'

import { IOssConfig, OssConfig } from '~/config'

@Injectable()
export class NetDiskManageService {
  private config: conf.Config
  private mac: auth.digest.Mac
  private bucketManager: rs.BucketManager

  constructor(
    @Inject(OssConfig.KEY) private qiniuConfig: IOssConfig,
    // ... å…¶ä»–æœåŠ¡
  ) {
    this.mac = new qiniu.auth.digest.Mac(
      this.qiniuConfig.accessKey,
      this.qiniuConfig.secretKey,
    )
    this.config = new qiniu.conf.Config({
      zone: this.qiniuConfig.zone,
    })
    this.bucketManager = new qiniu.rs.BucketManager(this.mac, this.config)
  }
// ... å…¶ä»–æ–¹æ³•
}
```

### 2. è·å–ä¸Šä¼ å‡­è¯

ä¸ƒç‰›äº‘å­˜å‚¨éœ€è¦å®¢æˆ·ç«¯åœ¨ä¸Šä¼ æ–‡ä»¶å‰è·å–ä¸€ä¸ªä¸Šä¼ å‡­è¯ (Upload Token)ã€‚`NetDiskManageService.createUploadToken` æ–¹æ³•è´Ÿè´£ç”Ÿæˆè¿™ä¸ªå‡­è¯ã€‚

```typescript
// src/modules/netdisk/manager/manage.service.ts
// ... existing code ...
  /**
   * åˆ›å»ºUpload Token, é»˜è®¤è¿‡æœŸæ—¶é—´ä¸€å°æ—¶
   * @param endUser ç»ˆç«¯ç”¨æˆ·æ ‡è¯†
   * @returns ä¸Šä¼ å‡­è¯
   */
  createUploadToken(endUser: string): string {
    const policy = new qiniu.rs.PutPolicy({
      scope: this.qiniuConfig.bucket, // å­˜å‚¨æ¡¶åç§°
      insertOnly: 1, // åªå…è®¸æ–°å¢ï¼Œä¸å…è®¸è¦†ç›–
      fsizeLimit: 1024 ** 2 * 10, // æ–‡ä»¶å¤§å°é™åˆ¶ï¼Œä¾‹å¦‚ 10MB
      endUser, // ç»ˆç«¯ç”¨æˆ·æ ‡è¯†ï¼Œç”¨äºæ—¥å¿—è®°å½•å’Œç»Ÿè®¡
    })
    const uploadToken = policy.uploadToken(this.mac)
    return uploadToken
  }
// ... existing code ...
```

*   å‰ç«¯åº”ç”¨åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°ä¸ƒç‰›äº‘å‰ï¼Œä¼šå‘åç«¯è¯·æ±‚è¿™ä¸ªä¸Šä¼ å‡­è¯ã€‚å®¢æˆ·ç«¯æ‹¿åˆ°å‡­è¯åï¼Œå¯ä»¥ç›´æ¥å°†æ–‡ä»¶ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ï¼Œè€Œä¸éœ€è¦ç»è¿‡åç«¯æœåŠ¡å™¨ï¼Œä»è€Œå‡è½»åç«¯å‹åŠ›ã€‚

### 3. æ–‡ä»¶åˆ—è¡¨ä¸ç®¡ç†

`NetDiskManageService` è¿˜æä¾›äº†æ–‡ä»¶åˆ—è¡¨æŸ¥è¯¢ã€æ–‡ä»¶ä¿¡æ¯è·å–ç­‰åŠŸèƒ½ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯é€šè¿‡ä¸ƒç‰›äº‘çš„ SDK æ¥å®ç°çš„ã€‚

```typescript
// src/modules/netdisk/manager/manage.service.ts
// ... existing code ...
  /**
   * è·å–æ–‡ä»¶åˆ—è¡¨
   * @param prefix ç›®å½•å‰ç¼€
   * @param marker ç¿»é¡µæ ‡å¿—
   * @param skey æœç´¢å…³é”®å­—
   * @returns æ–‡ä»¶åˆ—è¡¨å’Œç¿»é¡µæ ‡å¿—
   */
  async getFileList(prefix = '', marker = '', skey = ''): Promise<SFileList> {
    return new Promise((resolve, reject) => {
      this.bucketManager.listPrefix(
        this.qiniuConfig.bucket,
        {
          limit: NETDISK_LIMIT, // æ¯æ¬¡æŸ¥è¯¢çš„æ–‡ä»¶æ•°é‡é™åˆ¶
          prefix,
          marker,
        },
        (err, respBody, respInfo) => {
          if (err) {
            reject(err)
          }
          else if (respInfo.statusCode === 200) {
            // å¤„ç†æ–‡ä»¶åˆ—è¡¨æ•°æ®
            const fileList: SFileInfoDetail[] = respBody.items.map((item) => {
              return {
                key: item.key,
                hash: item.hash,
                fsize: item.fsize,
                mimeType: item.mimeType,
                putTime: item.putTime,
                type: item.type,
                url: `${this.qiniuConfig.domain}/${item.key}`, // æ‹¼æ¥å®Œæ•´çš„è®¿é—® URL
                // ... å…¶ä»–å±æ€§
              }
            })
            resolve({
              list: fileList,
              marker: respBody.marker || null,
            })
          }
          else {
            reject(
              new Error(
                `Qiniu Error Code: ${respInfo.statusCode}, Info: ${respInfo.statusMessage}`,
              ),
            )
          }
        },
      )
    })
  }
// ... å…¶ä»–æ–‡ä»¶æ“ä½œæ–¹æ³• (ä¾‹å¦‚æ–‡ä»¶åˆ é™¤ã€æ–‡ä»¶å¤åˆ¶ã€æ–‡ä»¶ç§»åŠ¨ç­‰)
```

## âœ¨ æœ€ä½³å®è·µæ€»ç»“

*   **äº‘å­˜å‚¨ä¼˜å…ˆ**ï¼šå¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œä¼˜å…ˆé€‰æ‹©ä¸“ä¸šçš„äº‘å­˜å‚¨æœåŠ¡ï¼ˆå¦‚ä¸ƒç‰›äº‘ OSSã€é˜¿é‡Œäº‘ OSSï¼‰ï¼Œå®ƒä»¬æä¾›é«˜å¯ç”¨ã€é«˜æ‰©å±•ã€é«˜å®‰å…¨çš„æ–‡ä»¶å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚
*   **å®‰å…¨å‡­è¯ç®¡ç†**ï¼šå°† OSS çš„ AccessKey å’Œ SecretKey ä½œä¸ºç¯å¢ƒå˜é‡å­˜å‚¨ï¼Œåˆ‡å‹¿ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ã€‚ä¸¥æ ¼æ§åˆ¶è¿™äº›å‡­è¯çš„è®¿é—®æƒé™ã€‚
*   **å¯ç”¨ä¸Šä¼ å‡­è¯**ï¼šå¦‚æœä½¿ç”¨äº‘å­˜å‚¨ï¼Œå®¢æˆ·ç«¯é€šè¿‡åç«¯è·å–ä¸Šä¼ å‡­è¯åç›´æ¥ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼Œå¯ä»¥æœ‰æ•ˆå‡è½»åç«¯æœåŠ¡å™¨çš„è´Ÿè½½ã€‚
*   **æ–‡ä»¶å…ƒæ•°æ®ç®¡ç†**ï¼šåœ¨æ•°æ®åº“ä¸­ä¿å­˜æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆæ–‡ä»¶åã€å¤§å°ã€ç±»å‹ã€è·¯å¾„ã€ä¸Šä¼ è€…ç­‰ï¼‰ï¼Œæ–¹ä¾¿åç»­çš„æ–‡ä»¶æŸ¥è¯¢ã€ç®¡ç†å’Œç»Ÿè®¡ã€‚
*   **æ–‡ä»¶è·¯å¾„è§„åˆ’**ï¼šåˆç†è§„åˆ’æ–‡ä»¶åœ¨ OSS ä¸­çš„å­˜å‚¨è·¯å¾„ï¼ˆä¾‹å¦‚æŒ‰æ—¥æœŸã€ç”¨æˆ· IDã€æ–‡ä»¶ç±»å‹ç­‰ï¼‰ï¼Œæ–¹ä¾¿æ–‡ä»¶å½’æ¡£å’ŒæŸ¥æ‰¾ã€‚
*   **é”™è¯¯å¤„ç†**ï¼šåœ¨æ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†è¿‡ç¨‹ä¸­ï¼Œåº”æ•è·å¹¶å¤„ç†å¯èƒ½çš„å¼‚å¸¸ï¼Œä¾‹å¦‚ç½‘ç»œé—®é¢˜ã€OSS è®¤è¯å¤±è´¥ã€æ–‡ä»¶è¯»å†™é”™è¯¯ç­‰ã€‚
*   **æ•°æ®å¤‡ä»½ä¸æ¢å¤**ï¼šå®šæœŸå¯¹ OSS ä¸­çš„é‡è¦æ•°æ®è¿›è¡Œå¤‡ä»½ï¼Œå¹¶åˆ¶å®šæ•°æ®æ¢å¤ç­–ç•¥ã€‚
*   **æˆæœ¬æ§åˆ¶**ï¼šäº†è§£ OSS çš„è®¡è´¹æ¨¡å¼ï¼Œåˆç†è§„åˆ’å­˜å‚¨ç©ºé—´å’Œæµé‡ä½¿ç”¨ï¼Œé¿å…ä¸å¿…è¦çš„æˆæœ¬å¼€é”€ã€‚

é€šè¿‡ä»¥ä¸Šè¿™äº›å®è·µï¼Œä½ å¯ä»¥ç¡®ä¿ `nest-admin` é¡¹ç›®çš„æ–‡ä»¶å­˜å‚¨åŠŸèƒ½ç¨³å®šã€å®‰å…¨ä¸”é«˜æ•ˆåœ°è¿è¡Œï¼ŒåŒæ—¶ä¸ºæœªæ¥çš„æ‰©å±•é¢„ç•™äº†ç©ºé—´ã€‚
