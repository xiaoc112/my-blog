# é‚®ä»¶æœåŠ¡é›†æˆæŒ‡å—

åŸºäº nest-admin é¡¹ç›®çš„é‚®ä»¶å‘é€å®è·µ

## ğŸ“š ç›®å½•

- [é‚®ä»¶æœåŠ¡é›†æˆæŒ‡å—](#é‚®ä»¶æœåŠ¡é›†æˆæŒ‡å—)
  - [ğŸ“š ç›®å½•](#-ç›®å½•)
  - [ğŸ’¡ æ¦‚è¿°](#-æ¦‚è¿°)
  - [âš™ï¸ é‚®ä»¶æœåŠ¡é…ç½®](#ï¸-é‚®ä»¶æœåŠ¡é…ç½®)
    - [é‚®ä»¶æ¨¡å—æ³¨å†Œ (`MailerModule`)](#é‚®ä»¶æ¨¡å—æ³¨å†Œ-mailermodule)
  - [ğŸ“ MailerService æ ¸å¿ƒåŠŸèƒ½](#-mailerservice-æ ¸å¿ƒåŠŸèƒ½)
  - [ğŸ“§ å‘é€é‚®ä»¶éªŒè¯ç ](#-å‘é€é‚®ä»¶éªŒè¯ç )
  - [âœ‰ï¸ å‘é€é€šç”¨é‚®ä»¶](#ï¸-å‘é€é€šç”¨é‚®ä»¶)
  - [â±ï¸ é‚®ä»¶å‘é€é™æµ](#ï¸-é‚®ä»¶å‘é€é™æµ)
  - [ğŸ“„ é‚®ä»¶æ¨¡æ¿ä½¿ç”¨](#-é‚®ä»¶æ¨¡æ¿ä½¿ç”¨)
  - [âœ¨ æœ€ä½³å®è·µæ€»ç»“](#-æœ€ä½³å®è·µæ€»ç»“)

## ğŸ’¡ æ¦‚è¿°

åœ¨è®¸å¤šåº”ç”¨åœºæ™¯ä¸­ï¼Œé‚®ä»¶æœåŠ¡æ˜¯ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚ç”¨æˆ·æ³¨å†ŒéªŒè¯ã€å¯†ç é‡ç½®ã€ç³»ç»Ÿé€šçŸ¥ç­‰ã€‚`nest-admin` é¡¹ç›®é›†æˆäº† `@nestjs-modules/mailer` æ¨¡å—ï¼Œå¹¶åŸºäºæ­¤å°è£…äº† `MailerService`ï¼Œæä¾›äº†ä¾¿æ·çš„é‚®ä»¶å‘é€åŠŸèƒ½ï¼ŒåŒæ—¶å®ç°äº†é‚®ä»¶å‘é€çš„é¢‘ç‡é™åˆ¶ï¼Œç¡®ä¿æœåŠ¡çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚

## âš™ï¸ é‚®ä»¶æœåŠ¡é…ç½®

é‚®ä»¶æœåŠ¡çš„é…ç½®ä¿¡æ¯ä¸»è¦é›†ä¸­åœ¨ `src/config/mailer.config.ts` æ–‡ä»¶ä¸­ã€‚è¿™äº›é…ç½®é¡¹å®šä¹‰äº† SMTP æœåŠ¡å™¨çš„è¿æ¥å‚æ•°å’Œè®¤è¯ä¿¡æ¯ã€‚

```typescript
// src/config/mailer.config.ts
import { ConfigType, registerAs } from '@nestjs/config'

import { env, envNumber } from '~/global/env'

export const mailerRegToken = 'mailer'

export const MailerConfig = registerAs(mailerRegToken, () => ({
  host: env('SMTP_HOST'), // SMTP æœåŠ¡å™¨ä¸»æœºåœ°å€
  port: envNumber('SMTP_PORT'), // SMTP æœåŠ¡å™¨ç«¯å£
  ignoreTLS: true, // æ˜¯å¦å¿½ç•¥ TLS è¯ä¹¦éªŒè¯ï¼ˆä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨ï¼‰
  secure: true, // æ˜¯å¦ä½¿ç”¨ TLS å®‰å…¨è¿æ¥ï¼ˆå¯¹äº 465 ç«¯å£é€šå¸¸ä¸º trueï¼‰
  auth: { // è®¤è¯ä¿¡æ¯
    user: env('SMTP_USER'), // SMTP è®¤è¯ç”¨æˆ·åï¼ˆé€šå¸¸ä¸ºé‚®ç®±åœ°å€ï¼‰
    pass: env('SMTP_PASS'), // SMTP è®¤è¯å¯†ç ï¼ˆæˆ–æˆæƒç ï¼‰
  },
}))

export type IMailerConfig = ConfigType<typeof MailerConfig>
```

**å…³é”®é…ç½®é¡¹ï¼š**

*   `host` å’Œ `port`ï¼šä½ çš„é‚®ä»¶æœåŠ¡æä¾›å•†ï¼ˆå¦‚ QQ é‚®ç®±ã€Gmailã€é˜¿é‡Œäº‘é‚®ä»¶æ¨é€ç­‰ï¼‰æä¾›çš„ SMTP æœåŠ¡å™¨åœ°å€å’Œç«¯å£ã€‚å¸¸è§çš„ç«¯å£æœ‰ 465 (SMTPS) æˆ– 587 (Submission)ã€‚
*   `secure`ï¼šè®¾ç½®ä¸º `true` è¡¨ç¤ºä½¿ç”¨ TLS/SSL å®‰å…¨è¿æ¥ã€‚å¦‚æœç«¯å£æ˜¯ 465ï¼Œé€šå¸¸è®¾ç½®ä¸º `true`ï¼›å¦‚æœç«¯å£æ˜¯ 587ï¼Œå¯èƒ½è®¾ç½®ä¸º `false` å¹¶ç»“åˆ `starttls`ã€‚
*   `auth.user` å’Œ `auth.pass`ï¼šç”¨äº SMTP æœåŠ¡å™¨è®¤è¯çš„ç”¨æˆ·åå’Œå¯†ç ã€‚è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„å¯†ç é€šå¸¸ä¸æ˜¯ä½ çš„é‚®ç®±ç™»å½•å¯†ç ï¼Œè€Œæ˜¯é‚®ä»¶æœåŠ¡æä¾›å•†ç”Ÿæˆçš„"æˆæƒç "æˆ–"å®¢æˆ·ç«¯å¯†ç "ï¼Œä»¥å¢å¼ºå®‰å…¨æ€§ã€‚

è¿™äº›é…ç½®é¡¹çš„å€¼é€šå¸¸ä» `.env` æ–‡ä»¶ä¸­è¯»å–ï¼Œä»¥ä¾¿åœ¨ä¸åŒç¯å¢ƒä¸­çµæ´»é…ç½®ã€‚

### é‚®ä»¶æ¨¡å—æ³¨å†Œ (`MailerModule`)

`MailerModule` åœ¨ `src/shared/mailer/mailer.module.ts` ä¸­è¢«æ³¨å†Œåˆ° NestJS åº”ç”¨ä¸­ã€‚å®ƒé€šè¿‡ `forRootAsync` æ–¹æ³•å¼‚æ­¥åŠ è½½é…ç½®ã€‚

```typescript
// src/shared/mailer/mailer.module.ts
import { join } from 'node:path'

import { MailerModule as NestMailerModule } from '@nestjs-modules/mailer'
import { HandlebarsAdapter } from '@nestjs-modules/mailer/dist/adapters/handlebars.adapter'
import { Module, Provider } from '@nestjs/common'
import { ConfigModule, ConfigService } from '@nestjs/config'

import { ConfigKeyPaths, IAppConfig, IMailerConfig } from '~/config'

import { MailerService } from './mailer.service'

const providers: Provider<any>[] = [
  MailerService,
]

@Module({
  imports: [
    NestMailerModule.forRootAsync({
      imports: [ConfigModule],
      useFactory: (configService: ConfigService<ConfigKeyPaths>) => ({
        transport: configService.get<IMailerConfig>('mailer'), // ä»é…ç½®æœåŠ¡è·å–é‚®ä»¶ä¼ è¾“é…ç½®
        defaults: {
          from: {
            name: configService.get<IAppConfig>('app').name, // é»˜è®¤å‘ä»¶äººåç§°ä¸ºåº”ç”¨åç§°
            address: configService.get<IMailerConfig>('mailer').auth.user, // é»˜è®¤å‘ä»¶äººåœ°å€ä¸ºè®¤è¯ç”¨æˆ·
          },
        },
        template: {
          dir: join(__dirname, '..', '..', '/assets/templates'), // é‚®ä»¶æ¨¡æ¿ç›®å½•
          adapter: new HandlebarsAdapter(), // ä½¿ç”¨ Handlebars ä½œä¸ºæ¨¡æ¿å¼•æ“
          options: {
            strict: true,
          },
        },
      }),
      inject: [ConfigService],
    }),
  ],
  providers,
  exports: providers,
})
export class MailerModule {}
```

*   **`transport`**ï¼šåŠ è½½ `mailer.config.ts` ä¸­å®šä¹‰çš„ SMTP ä¼ è¾“é…ç½®ã€‚
*   **`defaults.from`**ï¼šè®¾ç½®é‚®ä»¶çš„é»˜è®¤å‘ä»¶äººåç§°å’Œåœ°å€ã€‚è¿™å¯ä»¥ç¡®ä¿æ‰€æœ‰é‚®ä»¶éƒ½ä»¥ä¸€ä¸ªç»Ÿä¸€ä¸”ä¸“ä¸šçš„èº«ä»½å‘é€ã€‚
*   **`template`**ï¼šé…ç½®é‚®ä»¶æ¨¡æ¿ã€‚`dir` æŒ‡å®šäº†æ¨¡æ¿æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼ˆé€šå¸¸æ˜¯ `src/assets/templates`ï¼‰ï¼Œ`adapter` æŒ‡å®šäº†ä½¿ç”¨çš„æ¨¡æ¿å¼•æ“ã€‚æœ¬é¡¹ç›®ä½¿ç”¨ `HandlebarsAdapter`ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨ Handlebars æ¨¡æ¿è¯­æ³•æ¥ç¼–å†™åŠ¨æ€é‚®ä»¶å†…å®¹ã€‚

## ğŸ“ MailerService æ ¸å¿ƒåŠŸèƒ½

`MailerService` (`src/shared/mailer/mailer.service.ts`) å°è£…äº†é‚®ä»¶å‘é€çš„æ ¸å¿ƒé€»è¾‘ï¼Œå¹¶ä¸ Redis ç»“åˆå®ç°äº†é‚®ä»¶å‘é€çš„é™æµåŠŸèƒ½ã€‚

```typescript
import { MailerService as NestMailerService } from '@nestjs-modules/mailer'

// src/shared/mailer/mailer.service.ts
import { Inject, Injectable } from '@nestjs/common'
import dayjs from 'dayjs'

import Redis from 'ioredis'

import { InjectRedis } from '~/common/decorators/inject-redis.decorator'
import { BusinessException } from '~/common/exceptions/biz.exception'
import { AppConfig, IAppConfig } from '~/config'
import { ErrorEnum } from '~/constants/error-code.constant'
import { randomValue } from '~/utils'

@Injectable()
export class MailerService {
  constructor(
    @Inject(AppConfig.KEY) private appConfig: IAppConfig,
    @InjectRedis() private redis: Redis,
    private mailerService: NestMailerService,
  ) {}

  // è®°å½•é‚®ä»¶å‘é€æ—¥å¿—å’Œé™æµä¿¡æ¯
  async log(to: string, code: string, ip: string) {
    const getRemainTime = () => {
      const now = dayjs()
      return now.endOf('day').diff(now, 'second') // è®¡ç®—åˆ°å½“å¤©ç»“æŸçš„å‰©ä½™ç§’æ•°
    }

    await this.redis.set(`captcha:${to}`, code, 'EX', 60 * 5) // éªŒè¯ç  5 åˆ†é’Ÿè¿‡æœŸ

    // è®°å½•é‚®ç®±å’Œ IP çš„æ—¥å‘é€é™åˆ¶
    const limitCountOfDay = await this.redis.get(`captcha:${to}:limit-day`)
    const ipLimitCountOfDay = await this.redis.get(`ip:${ip}:send:limit-day`)

    await this.redis.set(`ip:${ip}:send:limit`, 1, 'EX', 60) // IP 60 ç§’å†…å‘é€é™åˆ¶
    await this.redis.set(`captcha:${to}:limit`, 1, 'EX', 60) // é‚®ç®± 60 ç§’å†…å‘é€é™åˆ¶
    await this.redis.set(
      `captcha:${to}:send:limit-count-day`,
      limitCountOfDay,
      'EX',
      getRemainTime(),
    )
    await this.redis.set(
      `ip:${ip}:send:limit-count-day`,
      ipLimitCountOfDay,
      'EX',
      getRemainTime(),
    )
  }

  // æ£€æŸ¥éªŒè¯ç 
  async checkCode(to, code) {
    const ret = await this.redis.get(`captcha:${to}`)
    if (ret !== code)
      throw new BusinessException(ErrorEnum.INVALID_VERIFICATION_CODE)

    await this.redis.del(`captcha:${to}`)
  }

  // æ£€æŸ¥é‚®ä»¶å‘é€é¢‘ç‡é™åˆ¶
  async checkLimit(to, ip) {
    const LIMIT_TIME = 5 // æ¯æ—¥æœ€å¤§å‘é€æ¬¡æ•°

    // IP é™åˆ¶ (æ¯ 60 ç§’)
    const ipLimit = await this.redis.get(`ip:${ip}:send:limit`)
    if (ipLimit)
      throw new BusinessException(ErrorEnum.TOO_MANY_REQUESTS)

    // é‚®ç®±é™åˆ¶ (æ¯ 60 ç§’)
    const limit = await this.redis.get(`captcha:${to}:limit`)
    if (limit)
      throw new BusinessException(ErrorEnum.TOO_MANY_REQUESTS)

    // æ¯æ—¥é‚®ç®±å‘é€æ¬¡æ•°é™åˆ¶
    let limitCountOfDay: string | number = await this.redis.get(
      `captcha:${to}:limit-day`,
    )
    limitCountOfDay = limitCountOfDay ? Number(limitCountOfDay) : 0
    if (limitCountOfDay > LIMIT_TIME) {
      throw new BusinessException(
        ErrorEnum.MAXIMUM_FIVE_VERIFICATION_CODES_PER_DAY,
      )
    }

    // æ¯æ—¥ IP å‘é€æ¬¡æ•°é™åˆ¶
    let ipLimitCountOfDay: string | number = await this.redis.get(
      `ip:${ip}:send:limit-day`,
    )
    ipLimitCountOfDay = ipLimitCountOfDay ? Number(ipLimitCountOfDay) : 0
    if (ipLimitCountOfDay > LIMIT_TIME) {
      throw new BusinessException(
        ErrorEnum.MAXIMUM_FIVE_VERIFICATION_CODES_PER_DAY,
      )
    }
  }

  // å‘é€é€šç”¨é‚®ä»¶ï¼ˆæ–‡æœ¬æˆ– HTML å†…å®¹ï¼‰
  async send(
    to,
    subject,
    content: string,
    type: 'text' | 'html' = 'text',
  ): Promise<any> {
    if (type === 'text') {
      return this.mailerService.sendMail({
        to,
        subject,
        text: content,
      })
    }
    else {
      return this.mailerService.sendMail({
        to,
        subject,
        html: content,
      })
    }
  }

  // å‘é€éªŒè¯ç é‚®ä»¶
  async sendVerificationCode(to, code = randomValue(4, '1234567890')) {
    const subject = `[${this.appConfig.name}] éªŒè¯ç `

    try {
      await this.mailerService.sendMail({
        to,
        subject,
        template: './verification-code-zh', // ä½¿ç”¨é¢„å®šä¹‰çš„ Handlebars æ¨¡æ¿
        context: {
          code,
        },
      })
    }
    catch (error) {
      console.log(error)
      throw new BusinessException(ErrorEnum.VERIFICATION_CODE_SEND_FAILED)
    }

    return {
      to,
      code,
    }
  }
}
```

## ğŸ“§ å‘é€é‚®ä»¶éªŒè¯ç 

å‘é€é‚®ä»¶éªŒè¯ç æ˜¯ç”¨æˆ·æ³¨å†Œã€å¯†ç é‡ç½®ç­‰åœºæ™¯çš„å¸¸è§éœ€æ±‚ã€‚`nest-admin` é€šè¿‡ `AuthController` ä¸­çš„ `EmailController` æä¾›äº†å‘é€éªŒè¯ç çš„ API æ¥å£ã€‚

```typescript
// modules/auth/controllers/email.controller.ts
import { Body, Controller, Post, UseGuards } from '@nestjs/common'
import { ApiOperation, ApiTags } from '@nestjs/swagger'
import { Throttle, ThrottlerGuard } from '@nestjs/throttler'

import { Ip } from '~/common/decorators/http.decorator'
import { MailerService } from '~/shared/mailer/mailer.service'
import { Public } from '../decorators/public.decorator'
import { SendEmailCodeDto } from '../dto/captcha.dto'

@ApiTags('Auth - è®¤è¯æ¨¡å—')
@UseGuards(ThrottlerGuard) // åº”ç”¨é™æµå®ˆå«
@Controller('auth/email')
export class EmailController {
  constructor(private mailerService: MailerService) {}

  @Post('send')
  @ApiOperation({ summary: 'å‘é€é‚®ç®±éªŒè¯ç ' })
  @Public() // å…¬å…±æ¥å£ï¼Œä¸éœ€è¦è®¤è¯
  @Throttle({ default: { limit: 2, ttl: 600000 } }) // è®¾ç½®è¯¥æ¥å£çš„é™æµè§„åˆ™ï¼š10 åˆ†é’Ÿå†…æœ€å¤šå‘é€ 2 æ¬¡
  async sendEmailCode(
    @Body() dto: SendEmailCodeDto,
    @Ip() ip: string, // è·å–è¯·æ±‚ IP åœ°å€
  ): Promise<void> {
    const { email } = dto

    // æ£€æŸ¥å‘é€é¢‘ç‡é™åˆ¶
    await this.mailerService.checkLimit(email, ip)

    // å‘é€éªŒè¯ç 
    const { code } = await this.mailerService.sendVerificationCode(email)

    // è®°å½•å‘é€æ—¥å¿—
    await this.mailerService.log(email, code, ip)
  }
}
```

**ä½¿ç”¨æ­¥éª¤ï¼š**

1.  **å®¢æˆ·ç«¯è¯·æ±‚**ï¼šå‰ç«¯åº”ç”¨å‘ `/auth/email/send` æ¥å£å‘é€ POST è¯·æ±‚ï¼Œæºå¸¦é‚®ç®±åœ°å€ã€‚
2.  **é™æµæ£€æŸ¥**ï¼š`ThrottlerGuard` å’Œ `mailerService.checkLimit` ä¼šå¯¹è¯·æ±‚è¿›è¡Œé™æµï¼Œé˜²æ­¢æ¶æ„åˆ·å–éªŒè¯ç ã€‚
3.  **å‘é€éªŒè¯ç **ï¼š`mailerService.sendVerificationCode` ä¼šç”Ÿæˆä¸€ä¸ªéšæœºéªŒè¯ç ï¼Œå¹¶ä½¿ç”¨é¢„å®šä¹‰çš„æ¨¡æ¿å‘é€é‚®ä»¶ã€‚
4.  **æ—¥å¿—è®°å½•**ï¼š`mailerService.log` ä¼šè®°å½•å‘é€æ—¥å¿—ï¼Œå¹¶æ›´æ–° Redis ä¸­çš„é™æµè®¡æ•°å™¨ã€‚

## âœ‰ï¸ å‘é€é€šç”¨é‚®ä»¶

é™¤äº†å‘é€éªŒè¯ç ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ `MailerService` å‘é€åŒ…å«è‡ªå®šä¹‰ä¸»é¢˜å’Œå†…å®¹çš„é€šç”¨é‚®ä»¶ï¼ˆæ–‡æœ¬æˆ– HTML æ ¼å¼ï¼‰ã€‚

```typescript
// modules/tools/email/email.controller.ts
import { Body, Controller, Post } from '@nestjs/common'
import { ApiOperation, ApiTags } from '@nestjs/swagger'

import { ApiSecurityAuth } from '~/common/decorators/swagger.decorator'
import { MailerService } from '~/shared/mailer/mailer.service'

import { EmailSendDto } from './email.dto'

@ApiTags('System - é‚®ç®±æ¨¡å—')
@ApiSecurityAuth() // éœ€è¦è®¤è¯æ‰èƒ½è®¿é—®
@Controller('email')
export class EmailController {
  constructor(private emailService: MailerService) {}

  @ApiOperation({ summary: 'å‘é€é‚®ä»¶' })
  @Post('send')
  async send(@Body() dto: EmailSendDto): Promise<void> {
    const { to, subject, content } = dto
    await this.emailService.send(to, subject, content, 'html') // ä»¥ HTML æ ¼å¼å‘é€é‚®ä»¶
  }
}
```

**ä½¿ç”¨ `mailerService.send` æ–¹æ³•ï¼š**

*   `to`ï¼šæ”¶ä»¶äººé‚®ç®±åœ°å€ã€‚
*   `subject`ï¼šé‚®ä»¶ä¸»é¢˜ã€‚
*   `content`ï¼šé‚®ä»¶æ­£æ–‡ã€‚å¯ä»¥æ˜¯çº¯æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥æ˜¯ HTML å­—ç¬¦ä¸²ã€‚
*   `type`ï¼šé‚®ä»¶å†…å®¹ç±»å‹ï¼Œå¯é€‰å€¼ä¸º `'text'` æˆ– `'html'`ï¼Œé»˜è®¤ä¸º `'text'`ã€‚

## â±ï¸ é‚®ä»¶å‘é€é™æµ

ä¸ºäº†é˜²æ­¢é‚®ä»¶æ¥å£è¢«æ»¥ç”¨ï¼Œ`MailerService` å®ç°äº†åŸºäº Redis çš„é‚®ä»¶å‘é€é™æµæœºåˆ¶ã€‚è¿™åŒ…æ‹¬ï¼š

*   **IP åœ°å€é™åˆ¶**ï¼šé˜²æ­¢åŒä¸€ IP åœ°å€åœ¨çŸ­æ—¶é—´å†…å‘é€è¿‡å¤šé‚®ä»¶ã€‚
*   **é‚®ç®±åœ°å€é™åˆ¶**ï¼šé˜²æ­¢åŒä¸€é‚®ç®±åœ°å€åœ¨çŸ­æ—¶é—´å†…æ¥æ”¶è¿‡å¤šé‚®ä»¶ã€‚
*   **æ¯æ—¥å‘é€é™åˆ¶**ï¼šé™åˆ¶å•ä¸ª IP æˆ–å•ä¸ªé‚®ç®±åœ¨ä¸€å¤©å†…çš„æ€»å‘é€æ¬¡æ•°ã€‚

è¿™äº›é™åˆ¶é€šè¿‡ `mailerService.checkLimit` æ–¹æ³•å®ç°ï¼Œå¹¶åœ¨å‘é€éªŒè¯ç çš„ API æ¥å£ä¸­è¢«è°ƒç”¨ã€‚å½“è§¦å‘é™æµæ—¶ï¼Œä¼šæŠ›å‡º `BusinessException`ï¼Œè¿”å›ç›¸åº”çš„é”™è¯¯ç ã€‚

## ğŸ“„ é‚®ä»¶æ¨¡æ¿ä½¿ç”¨

`nest-admin` é¡¹ç›®é€šè¿‡ `HandlebarsAdapter` é›†æˆäº† Handlebars é‚®ä»¶æ¨¡æ¿ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åˆ›å»º `.hbs` æ ¼å¼çš„æ¨¡æ¿æ–‡ä»¶ï¼Œå¹¶åœ¨å‘é€é‚®ä»¶æ—¶åŠ¨æ€å¡«å……æ•°æ®ã€‚

**æ¨¡æ¿ç›®å½•**ï¼š`src/assets/templates`

**æ¨¡æ¿æ–‡ä»¶ç¤ºä¾‹ (`verification-code-zh.hbs`)ï¼š**

```html
<!DOCTYPE html>
<html>
<head>
    <title>éªŒè¯ç </title>
</head>
<body>
    <p>æ‚¨å¥½ï¼</p>
    <p>æ‚¨æ­£åœ¨è¿›è¡Œè´¦æˆ·éªŒè¯ï¼Œæ‚¨çš„éªŒè¯ç æ˜¯ï¼š</p>
    <h3>{{code}}</h3>
    <p>æ­¤éªŒè¯ç  5 åˆ†é’Ÿå†…æœ‰æ•ˆã€‚è¯·å‹¿å°†éªŒè¯ç é€éœ²ç»™ä»–äººã€‚</p>
    <p>å¦‚æœè¿™ä¸æ˜¯æ‚¨æœ¬äººçš„æ“ä½œï¼Œè¯·å¿½ç•¥æ­¤é‚®ä»¶ã€‚</p>
    <p>è°¢è°¢ï¼</p>
    <p>æ‚¨çš„åº”ç”¨ç¨‹åºå›¢é˜Ÿ</p>
</body>
</html>
```

**åœ¨ `sendVerificationCode` ä¸­ä½¿ç”¨æ¨¡æ¿ï¼š**

```typescript
// src/shared/mailer/mailer.service.ts
// ... existing code ...
  async sendVerificationCode(to, code = randomValue(4, '1234567890')) {
    const subject = `[${this.appConfig.name}] éªŒè¯ç `

    try {
      await this.mailerService.sendMail({
        to,
        subject,
        template: './verification-code-zh', // æŒ‡å®šè¦ä½¿ç”¨çš„æ¨¡æ¿æ–‡ä»¶ï¼ˆä¸å¸¦ .hbs åç¼€ï¼‰
        context: {
          code, // ä¼ é€’ç»™æ¨¡æ¿çš„æ•°æ®ï¼Œæ¨¡æ¿ä¸­å¯ä»¥é€šè¿‡ {{code}} è®¿é—®
        },
      })
    }
    catch (error) {
      console.log(error)
      throw new BusinessException(ErrorEnum.VERIFICATION_CODE_SEND_FAILED)
    }

    return {
      to,
      code,
    }
  }
// ... existing code ...
```

*   `template: './verification-code-zh'`ï¼šæŒ‡å®šäº† `src/assets/templates` ç›®å½•ä¸‹çš„ `verification-code-zh.hbs` æ–‡ä»¶ä½œä¸ºæ¨¡æ¿ã€‚
*   `context: { code }`ï¼šå°†ä¸€ä¸ªåŒ…å« `code` å±æ€§çš„å¯¹è±¡ä½œä¸ºæ•°æ®ä¼ é€’ç»™æ¨¡æ¿ã€‚åœ¨æ¨¡æ¿ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ `{{code}}` æ¥æ¸²æŸ“éªŒè¯ç ã€‚

## âœ¨ æœ€ä½³å®è·µæ€»ç»“

*   **ä½¿ç”¨æˆæƒç **ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨é‚®ä»¶æœåŠ¡æä¾›å•†ç”Ÿæˆçš„"æˆæƒç "æˆ–"å®¢æˆ·ç«¯å¯†ç "ï¼Œè€Œä¸æ˜¯ä½ çš„é‚®ç®±ç™»å½•å¯†ç ï¼Œä»¥æé«˜å®‰å…¨æ€§ã€‚
*   **é…ç½®å‘ä»¶äººä¿¡æ¯**ï¼šè®¾ç½®æ˜ç¡®çš„é»˜è®¤å‘ä»¶äººåç§°å’Œåœ°å€ï¼Œæé«˜é‚®ä»¶çš„å¯ä¿¡åº¦ã€‚
*   **åˆ©ç”¨é‚®ä»¶æ¨¡æ¿**ï¼šå¯¹äºéœ€è¦åŠ¨æ€å†…å®¹çš„é‚®ä»¶ï¼ˆå¦‚éªŒè¯ç ã€é€šçŸ¥ï¼‰ï¼Œä½¿ç”¨æ¨¡æ¿å¯ä»¥æ›´å¥½åœ°ç®¡ç†é‚®ä»¶å†…å®¹ï¼Œå®ç°å›½é™…åŒ–ã€‚
*   **å®æ–½é™æµ**ï¼šé‚®ä»¶å‘é€æ˜¯å®¹æ˜“è¢«æ»¥ç”¨çš„æ¥å£ï¼ŒåŠ¡å¿…å®ç°ä¸¥æ ¼çš„é™æµæœºåˆ¶ï¼ŒåŒ…æ‹¬ IPã€é‚®ç®±å’Œæ¯æ—¥å‘é€æ¬¡æ•°ç­‰ç»´åº¦ã€‚
*   **é”™è¯¯å¤„ç†**ï¼šåœ¨é‚®ä»¶å‘é€è¿‡ç¨‹ä¸­ï¼Œåº”æ•è·å¹¶å¤„ç†å¯èƒ½çš„å¼‚å¸¸ï¼Œä¾‹å¦‚ç½‘ç»œé—®é¢˜ã€è®¤è¯å¤±è´¥ã€SMTP æœåŠ¡å™¨é”™è¯¯ç­‰ï¼Œå¹¶ç»™äºˆç”¨æˆ·å‹å¥½çš„æç¤ºã€‚
*   **å¼‚æ­¥å‘é€**ï¼šå¯¹äºéå®æ—¶æ€§è¦æ±‚é«˜çš„é‚®ä»¶ï¼ˆå¦‚è¥é”€é‚®ä»¶ã€æ‰¹é‡é€šçŸ¥ï¼‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥å‘é€ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

é€šè¿‡éµå¾ªè¿™äº›å®è·µï¼Œä½ å¯ä»¥ç¡®ä¿ `nest-admin` é¡¹ç›®çš„é‚®ä»¶æœåŠ¡ç¨³å®šã€å®‰å…¨ä¸”é«˜æ•ˆåœ°è¿è¡Œã€‚
