# å®‰å…¨æ€§æœ€ä½³å®è·µæŒ‡å—

åŸºäº nest-admin é¡¹ç›®çš„å®‰å…¨è®¾è®¡ä¸å®ç°

## ğŸ“š ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [èº«ä»½è®¤è¯](#èº«ä»½è®¤è¯)
3. [æƒé™æ§åˆ¶ (RBAC)](#æƒé™æ§åˆ¶-rbac)
4. [æ•°æ®åŠ å¯†ä¸å®‰å…¨å­˜å‚¨](#æ•°æ®åŠ å¯†ä¸å®‰å…¨å­˜å‚¨)
5. [è¾“å…¥éªŒè¯ä¸æ•°æ®æ ¡éªŒ](#è¾“å…¥éªŒè¯ä¸æ•°æ®æ ¡éªŒ)
6. [æ¥å£é™æµ](#æ¥å£é™æµ)
7. [å¹‚ç­‰æ€§ä¿è¯](#å¹‚ç­‰æ€§ä¿è¯)
8. [å¸¸è§ Web å®‰å…¨é˜²æŠ¤](#å¸¸è§-web-å®‰å…¨é˜²æŠ¤)
9. [å®‰å…¨æ—¥å¿—ä¸ç›‘æ§](#å®‰å…¨æ—¥å¿—ä¸ç›‘æ§)
10. [æœ€ä½³å®è·µæ€»ç»“](#æœ€ä½³å®è·µæ€»ç»“)

## ğŸ’¡ æ¦‚è¿°

åœ¨ç°ä»£ Web åº”ç”¨ä¸­ï¼Œå®‰å…¨æ€§æ˜¯è‡³å…³é‡è¦çš„ä¸€ä¸ªæ–¹é¢ã€‚`nest-admin` é¡¹ç›®åœ¨è®¾è®¡å’Œå®ç°æ—¶ï¼Œå……åˆ†è€ƒè™‘äº†å¤šç§å®‰å…¨å¨èƒï¼Œå¹¶é‡‡å–äº†ä¸€ç³»åˆ—æªæ–½æ¥ä¿æŠ¤åº”ç”¨ç¨‹åºå’Œç”¨æˆ·æ•°æ®ã€‚æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»é¡¹ç›®ä¸­å®æ–½çš„å„é¡¹å®‰å…¨å®è·µï¼Œå¸®åŠ©ä½ ç†è§£å¹¶æ„å»ºæ›´å®‰å…¨çš„ NestJS åº”ç”¨ã€‚

## ğŸ” èº«ä»½è®¤è¯

èº«ä»½è®¤è¯æ˜¯ç¡®è®¤ç”¨æˆ·èº«ä»½çš„è¿‡ç¨‹ã€‚`nest-admin` é¡¹ç›®é‡‡ç”¨ **JWT (JSON Web Tokens)** è¿›è¡Œèº«ä»½è®¤è¯ï¼Œè¿™æ˜¯ä¸€ç§è½»é‡çº§ã€è‡ªåŒ…å«çš„è®¤è¯æ–¹å¼ï¼Œç‰¹åˆ«é€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿã€‚

### 1. JWT è®¤è¯æµç¨‹

1.  **ç”¨æˆ·ç™»å½•**ï¼šç”¨æˆ·é€šè¿‡ç”¨æˆ·åå’Œå¯†ç å‘è®¤è¯æ¥å£å‘èµ·è¯·æ±‚ã€‚
2.  **ç”Ÿæˆä»¤ç‰Œ**ï¼šæœåŠ¡å™¨éªŒè¯ç”¨æˆ·å‡­æ®åï¼Œä½¿ç”¨å¯†é’¥ç­¾åç”Ÿæˆ `AccessToken` å’Œ `RefreshToken`ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚
3.  **æºå¸¦ä»¤ç‰Œ**ï¼šå®¢æˆ·ç«¯åœ¨åç»­è¯·æ±‚ä¸­ï¼Œå°† `AccessToken` æ”¾ç½®åœ¨ HTTP è¯·æ±‚å¤´çš„ `Authorization` å­—æ®µä¸­ï¼ˆé€šå¸¸ä»¥ `Bearer` å‰ç¼€ï¼‰ã€‚
4.  **éªŒè¯ä»¤ç‰Œ**ï¼šæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œé€šè¿‡ `JwtAuthGuard` éªŒè¯ `AccessToken` çš„æœ‰æ•ˆæ€§ï¼ˆç­¾åã€è¿‡æœŸæ—¶é—´ç­‰ï¼‰ã€‚
5.  **è·å–ç”¨æˆ·ä¿¡æ¯**ï¼šéªŒè¯æˆåŠŸåï¼Œä» `AccessToken` ä¸­è§£æå‡ºç”¨æˆ· ID ç­‰ä¿¡æ¯ï¼Œå¹¶å°†å…¶é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡ä¸­ï¼Œä¾›åç»­å¤„ç†ä½¿ç”¨ã€‚

### 2. JWT é…ç½®

JWT çš„ç›¸å…³é…ç½®ä½äº `src/config/security.config.ts` å’Œ `src/modules/auth/auth.module.ts` ä¸­ã€‚

```typescript
// src/config/security.config.ts
import { ConfigType, registerAs } from '@nestjs/config'

import { env, envNumber } from '~/global/env'

export const securityRegToken = 'security'

export const SecurityConfig = registerAs(securityRegToken, () => ({
  jwtSecret: env('JWT_SECRET'), // JWT ç­¾åå¯†é’¥ï¼Œåº”ä¿å¯†
  jwtExprire: envNumber('JWT_EXPIRE'), // AccessToken è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
  refreshSecret: env('REFRESH_TOKEN_SECRET'), // RefreshToken ç­¾åå¯†é’¥
  refreshExpire: envNumber('REFRESH_TOKEN_EXPIRE'), // RefreshToken è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
}))

export type ISecurityConfig = ConfigType<typeof SecurityConfig>
```

```typescript
// src/modules/auth/auth.module.ts
// ... existing code ...
    JwtModule.registerAsync({
      imports: [ConfigModule],
      useFactory: (configService: ConfigService<ConfigKeyPaths>) => {
        const { jwtSecret, jwtExprire }
          = configService.get<ISecurityConfig>('security')

        return {
          secret: jwtSecret,
          signOptions: {
            expiresIn: `${jwtExprire}s`,
          },
          ignoreExpiration: isDev, // å¼€å‘ç¯å¢ƒä¸‹å¿½ç•¥è¿‡æœŸï¼Œæ–¹ä¾¿è°ƒè¯•
        }
      },
      inject: [ConfigService],
    }),
// ... existing code ...
```

### 3. JWT è®¤è¯å®ˆå« (`JwtAuthGuard`)

`JwtAuthGuard` æ˜¯ä¸€ä¸ªå…¨å±€å®ˆå«ï¼Œè´Ÿè´£éªŒè¯æ‰€æœ‰å—ä¿æŠ¤æ¥å£çš„ JWT Tokenã€‚å¦‚æœ Token æ— æ•ˆæˆ–ç¼ºå¤±ï¼Œè¯·æ±‚å°†è¢«æ‹’ç»ã€‚

```typescript
// modules/auth/guards/jwt-auth.guard.ts
import { ExecutionContext, Injectable } from '@nestjs/common'
import { Reflector } from '@nestjs/core'
import { AuthGuard } from '@nestjs/passport'
import { Observable } from 'rxjs'

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {
  constructor(private reflector: Reflector) {
    super()
  }

  canActivate(context: ExecutionContext): boolean | Promise<boolean> | Observable<boolean> {
    // æ£€æŸ¥æ˜¯å¦ä¸ºå…¬å¼€æ¥å£ (é€šè¿‡ @Public() è£…é¥°å™¨æ ‡è®°)
    const isPublic = this.reflector.getAllAndOverride<boolean>('isPublic', [
      context.getHandler(),
      context.getClass(),
    ])

    if (isPublic) {
      return true
    }

    return super.canActivate(context)
  }
}
```

*   **`@Public()` è£…é¥°å™¨**ï¼šç”¨äºæ ‡è®°ä¸éœ€è¦ JWT è®¤è¯çš„å…¬å…±æ¥å£ï¼Œä¾‹å¦‚ç™»å½•ã€æ³¨å†Œã€è·å–éªŒè¯ç ç­‰ã€‚

## ğŸ”‘ æƒé™æ§åˆ¶ (RBAC)

æƒé™æ§åˆ¶æ˜¯ç¡®å®šç”¨æˆ·æ˜¯å¦æœ‰æƒæ‰§è¡ŒæŸä¸ªæ“ä½œçš„è¿‡ç¨‹ã€‚`nest-admin` é¡¹ç›®å®ç°äº† **RBAC (Role-Based Access Control)** æ¨¡å‹ï¼Œé€šè¿‡è§’è‰²å’Œæƒé™çš„å…³è”æ¥ç®¡ç†ç”¨æˆ·è®¿é—®ã€‚

### 1. RBAC æ¨¡å‹

*   **ç”¨æˆ· (User)**ï¼šç³»ç»Ÿä¸­çš„ä¸ªä½“ï¼Œå¯ä»¥æ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²ã€‚
*   **è§’è‰² (Role)**ï¼šä¸€ç»„æƒé™çš„é›†åˆï¼Œä¾‹å¦‚"ç®¡ç†å‘˜"ã€"æ™®é€šç”¨æˆ·"ç­‰ã€‚
*   **æƒé™ (Permission)**ï¼šå¯¹ç‰¹å®šèµ„æºæ‰§è¡Œç‰¹å®šæ“ä½œçš„æˆæƒï¼Œä¾‹å¦‚"ç”¨æˆ·ï¼šåˆ›å»º"ã€"æ–‡ç« ï¼šé˜…è¯»"ç­‰ã€‚

ç”¨æˆ·é€šè¿‡è¢«æˆäºˆè§’è‰²æ¥é—´æ¥è·å¾—æƒé™ã€‚è¿™ç§æ¨¡å‹ç®€åŒ–äº†æƒé™ç®¡ç†ï¼Œé™ä½äº†ç»´æŠ¤æˆæœ¬ã€‚

### 2. RBAC æƒé™å®ˆå« (`RbacGuard`)

`RbacGuard` æ˜¯ä¸€ä¸ªå…¨å±€å®ˆå«ï¼Œè´Ÿè´£æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·å¤‡æ‰§è¡Œè¯·æ±‚æ“ä½œæ‰€éœ€çš„æƒé™ã€‚

```typescript
// modules/auth/guards/rbac.guard.ts
import { CanActivate, ExecutionContext, ForbiddenException, Injectable } from '@nestjs/common'
import { Reflector } from '@nestjs/core'
import { AuthService } from '../auth.service'

@Injectable()
export class RbacGuard implements CanActivate {
  constructor(
    private reflector: Reflector,
    private authService: AuthService, // ç”¨äºæ£€æŸ¥ç”¨æˆ·æƒé™çš„æœåŠ¡
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    // è·å–æ¥å£æ‰€éœ€çš„æƒé™åˆ—è¡¨ (é€šè¿‡ @RequirePermissions() è£…é¥°å™¨æ ‡è®°)
    const requiredPermissions = this.reflector.getAllAndOverride<string[]>('permissions', [
      context.getHandler(),
      context.getClass(),
    ])

    if (!requiredPermissions) {
      return true // å¦‚æœæ¥å£æ²¡æœ‰æŒ‡å®šæƒé™ï¼Œåˆ™é»˜è®¤å…è®¸è®¿é—®
    }

    const request = context.switchToHttp().getRequest()
    const user = request.user // ä» JWT è®¤è¯ä¸­è·å–çš„ç”¨æˆ·ä¿¡æ¯

    // æ£€æŸ¥ç”¨æˆ·æƒé™
    const hasPermission = await this.authService.checkPermissions(user.id, requiredPermissions)

    if (!hasPermission) {
      throw new ForbiddenException('æƒé™ä¸è¶³') // æŠ›å‡º 403 Forbidden å¼‚å¸¸
    }

    return true
  }
}
```

### 3. æƒé™è£…é¥°å™¨ (`@RequirePermissions()`)

`@RequirePermissions()` è£…é¥°å™¨ç”¨äºæ ‡è®° API æ¥å£æ‰€éœ€çš„æƒé™ï¼Œå®ƒä¸ `RbacGuard` ååŒå·¥ä½œã€‚

```typescript
// common/decorators/permissions.decorator.ts
import { SetMetadata } from '@nestjs/common'

export function RequirePermissions(...permissions: string[]) {
  return SetMetadata('permissions', permissions)
}

// ä½¿ç”¨ç¤ºä¾‹
// modules/user/user.controller.ts
// ... existing code ...
  @Get()
  @RequirePermissions('user:read') // è®¿é—®æ­¤æ¥å£éœ€è¦ 'user:read' æƒé™
  async getUsers() {
    return this.userService.findAll()
  }

  @Post()
  @RequirePermissions('user:create') // è®¿é—®æ­¤æ¥å£éœ€è¦ 'user:create' æƒé™
  async createUser(@Body() userData: CreateUserDto) {
    return this.userService.create(userData)
  }
// ... existing code ...
```

## ğŸ”’ æ•°æ®åŠ å¯†ä¸å®‰å…¨å­˜å‚¨

### 1. å¯†ç å“ˆå¸Œ

é¡¹ç›®ä¸­å­˜å‚¨ç”¨æˆ·å¯†ç æ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨ä¸å¯é€†çš„å“ˆå¸Œç®—æ³•ï¼ˆå¦‚ bcryptï¼‰è¿›è¡ŒåŠ å¯†ã€‚è¿™æ„å‘³ç€å³ä½¿æ•°æ®åº“æ³„éœ²ï¼Œæ”»å‡»è€…ä¹Ÿæ— æ³•ç›´æ¥è·å–ç”¨æˆ·å¯†ç ã€‚

### 2. æ•æ„Ÿæ•°æ®åŠ å¯†

å¯¹äºå…¶ä»–æ•æ„Ÿæ•°æ®ï¼ˆä¾‹å¦‚ç”¨æˆ·æ‰‹æœºå·ã€é‚®ç®±ç­‰ï¼‰ï¼Œå¦‚æœéœ€è¦å­˜å‚¨ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å¯¹ç§°æˆ–éå¯¹ç§°åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œä»¥å¢åŠ æ•°æ®å®‰å…¨æ€§ã€‚

## ğŸ“ è¾“å…¥éªŒè¯ä¸æ•°æ®æ ¡éªŒ

ä¸¥æ ¼çš„è¾“å…¥éªŒè¯æ˜¯é˜²æ­¢æ¶æ„æ•°æ®æ³¨å…¥å’Œåº”ç”¨ç¨‹åºæ¼æ´çš„é‡è¦é˜²çº¿ã€‚`nest-admin` é¡¹ç›®é€šè¿‡ NestJS çš„ `ValidationPipe` å’Œ `class-validator` åº“å®ç°äº†å¼ºå¤§çš„æ•°æ®æ ¡éªŒã€‚

### 1. å…¨å±€ `ValidationPipe`

åœ¨ `src/main.ts` ä¸­ï¼Œ`ValidationPipe` è¢«é…ç½®ä¸ºå…¨å±€ç®¡é“ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰è¿›å…¥åº”ç”¨ç¨‹åºçš„è¯·æ±‚æ•°æ®éƒ½ä¼šè‡ªåŠ¨è¿›è¡Œæ ¡éªŒã€‚

```typescript
// src/main.ts
// ... existing code ...
app.useGlobalPipes(
  new ValidationPipe({
    transform: true, // è‡ªåŠ¨è½¬æ¢è¯·æ±‚æ•°æ®ç±»å‹
    whitelist: true, // è¿‡æ»¤æ‰æœªå®šä¹‰åœ¨ DTO ä¸­çš„å±æ€§
    transformOptions: { enableImplicitConversion: true }, // å¯ç”¨éšå¼ç±»å‹è½¬æ¢
    errorHttpStatusCode: HttpStatus.UNPROCESSABLE_ENTITY, // æ ¡éªŒå¤±è´¥æ—¶è¿”å› 422 çŠ¶æ€ç 
    stopAtFirstError: true, // å‘ç°ç¬¬ä¸€ä¸ªé”™è¯¯æ—¶ç«‹å³åœæ­¢æ ¡éªŒ
  }),
)
// ... existing code ...
```

*   `transform: true`ï¼šè‡ªåŠ¨å°†è¯·æ±‚å‚æ•°è½¬æ¢ä¸º DTO (Data Transfer Object) ä¸­å®šä¹‰çš„ç±»å‹ã€‚
*   `whitelist: true`ï¼šç§»é™¤è¯·æ±‚ä½“ä¸­é‚£äº› DTO ä¸­æ²¡æœ‰å®šä¹‰çš„é¢å¤–å±æ€§ï¼Œé˜²æ­¢æ„å¤–çš„æ•°æ®æ³¨å…¥ã€‚
*   `stopAtFirstError: true`ï¼šåœ¨æ£€æµ‹åˆ°ç¬¬ä¸€ä¸ªéªŒè¯é”™è¯¯æ—¶ç«‹å³åœæ­¢å¹¶è¿”å›ï¼Œæé«˜æ€§èƒ½ã€‚

### 2. ä½¿ç”¨ `class-validator` è£…é¥°å™¨

åœ¨ DTO ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ `class-validator` æä¾›çš„å„ç§è£…é¥°å™¨æ¥å®šä¹‰æ ¡éªŒè§„åˆ™ã€‚

```typescript
// modules/user/user.dto.ts
import { IsEmail, IsNotEmpty, IsOptional, IsString, Length } from 'class-validator'

export class CreateUserDto {
  @IsNotEmpty({ message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º' })
  @IsString({ message: 'ç”¨æˆ·åå¿…é¡»æ˜¯å­—ç¬¦ä¸²' })
  @Length(4, 20, { message: 'ç”¨æˆ·åé•¿åº¦ä¸º 4-20 ä¸ªå­—ç¬¦' })
  username: string

  @IsNotEmpty({ message: 'å¯†ç ä¸èƒ½ä¸ºç©º' })
  @IsString({ message: 'å¯†ç å¿…é¡»æ˜¯å­—ç¬¦ä¸²' })
  @Length(6, 30, { message: 'å¯†ç é•¿åº¦ä¸º 6-30 ä¸ªå­—ç¬¦' })
  password: string

  @IsOptional()
  @IsEmail({}, { message: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' })
  email?: string
}
```

## â±ï¸ æ¥å£é™æµ

æ¥å£é™æµæ˜¯é˜²æ­¢æ¶æ„æ”»å‡»ï¼ˆå¦‚æš´åŠ›ç ´è§£ã€DDoSï¼‰å’Œæ»¥ç”¨ API çš„é‡è¦æ‰‹æ®µã€‚`nest-admin` é¡¹ç›®ä½¿ç”¨äº† `@nestjs/throttler` æ¨¡å—æ¥å®ç°æ¥å£é™æµã€‚

### 1. å…¨å±€é™æµé…ç½®

åœ¨ `src/shared/shared.module.ts` ä¸­ï¼Œé…ç½®äº†å…¨å±€çš„é™æµè§„åˆ™ï¼Œå¹¶å°†å…¶ä½œä¸ºå…¨å±€å®ˆå«åœ¨ `src/app.module.ts` ä¸­å¯ç”¨ã€‚

```typescript
// src/shared/shared.module.ts
// ... existing code ...
    ThrottlerModule.forRoot([{
      limit: 20,  // æ¯ä¸ªå®¢æˆ·ç«¯åœ¨ ttl æ—¶é—´æ®µå†…æœ€å¤šå…è®¸ 20 æ¬¡è¯·æ±‚
      ttl: 60000, // æ—¶é—´çª—å£ï¼Œå•ä½æ¯«ç§’ (60000 æ¯«ç§’ = 1 åˆ†é’Ÿ)
    }]),
// ... existing code ...
```

```typescript
// src/app.module.ts
// ... existing code ...
    { provide: APP_GUARD, useClass: ThrottlerGuard }, // å…¨å±€å¯ç”¨é™æµå®ˆå«
// ... existing code ...
```

è¿™æ„å‘³ç€æ¯ä¸ªå®¢æˆ·ç«¯ï¼ˆé€šå¸¸é€šè¿‡ IP åœ°å€è¯†åˆ«ï¼‰åœ¨ 1 åˆ†é’Ÿå†…æœ€å¤šåªèƒ½å‘èµ· 20 æ¬¡è¯·æ±‚ã€‚å¦‚æœè¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼Œå°†ä¼šæ”¶åˆ° `429 Too Many Requests` é”™è¯¯å“åº”ã€‚

### 2. ç‰¹å®šæ¥å£é™æµ

ä½ å¯ä»¥é€šè¿‡ `@Throttle()` è£…é¥°å™¨ä¸ºç‰¹å®šçš„æ¥å£è®¾ç½®æ›´ä¸¥æ ¼æˆ–æ›´å®½æ¾çš„é™æµè§„åˆ™ã€‚

```typescript
// modules/auth/controllers/email.controller.ts
// ... existing code ...
  @Post('send')
  @ApiOperation({ summary: 'å‘é€é‚®ç®±éªŒè¯ç ' })
  @Public()
  @Throttle({ default: { limit: 2, ttl: 600000 } }) // 10 åˆ†é’Ÿå†…æœ€å¤šå‘é€ 2 æ¬¡é‚®ä»¶éªŒè¯ç 
  async sendEmailCode(
    @Body() dto: SendEmailCodeDto,
    @Ip() ip: string,
  ): Promise<void> {
// ... existing code ...
```

### 3. è·³è¿‡é™æµ

å¯¹äºæŸäº›ä¸éœ€è¦é™æµçš„æ¥å£ï¼ˆä¾‹å¦‚ SSE é•¿è¿æ¥ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `@SkipThrottle()` è£…é¥°å™¨è·³è¿‡é™æµã€‚

```typescript
// modules/sse/sse.controller.ts
// ... existing code ...
@SkipThrottle() // è·³è¿‡é™æµ
@Controller('sse')
// ... existing code ...
```

## ğŸ”„ å¹‚ç­‰æ€§ä¿è¯

å¹‚ç­‰æ€§æ˜¯æŒ‡ä¸€ä¸ªæ“ä½œæ‰§è¡Œå¤šæ¬¡å’Œæ‰§è¡Œä¸€æ¬¡äº§ç”Ÿçš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºç½‘ç»œæ³¢åŠ¨æˆ–å…¶ä»–åŸå› ï¼Œå®¢æˆ·ç«¯å¯èƒ½ä¼šé‡å¤å‘é€è¯·æ±‚ã€‚å¹‚ç­‰æ€§å¯ä»¥æœ‰æ•ˆé˜²æ­¢å› é‡å¤è¯·æ±‚å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚

### 1. å¹‚ç­‰æ€§æ‹¦æˆªå™¨ (`IdempotenceInterceptor`)

`nest-admin` é¡¹ç›®å®ç°äº† `IdempotenceInterceptor` æ¥ä¿è¯å…³é”®æ“ä½œçš„å¹‚ç­‰æ€§ï¼Œé˜²æ­¢é‡å¤æäº¤ã€‚

```typescript
// common/interceptors/idempotence.interceptor.ts
import { BadRequestException, CallHandler, ExecutionContext, Injectable, NestInterceptor } from '@nestjs/common'
import { Observable } from 'rxjs'
import { RedisService } from '~/shared/redis/redis.service'

@Injectable()
export class IdempotenceInterceptor implements NestInterceptor {
  constructor(private readonly cacheService: RedisService) {}

  async intercept(context: ExecutionContext, next: CallHandler): Promise<Observable<any>> {
    const request = context.switchToHttp().getRequest()
    const key = this.generateKey(request) // æ ¹æ®è¯·æ±‚æ–¹æ³•ã€URLã€Body å’Œç”¨æˆ· ID ç”Ÿæˆå”¯ä¸€é”®

    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè¯·æ±‚çš„ç¼“å­˜
    const exists = await this.cacheService.get(key)
    if (exists) {
      throw new BadRequestException('è¯·å‹¿é‡å¤æäº¤') // å¦‚æœå·²å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºé‡å¤æäº¤å¼‚å¸¸
    }

    // è®¾ç½®ç¼“å­˜ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆä¾‹å¦‚ 5 ç§’å†…é˜²é‡å¤ï¼‰
    await this.cacheService.set(key, '1', 5)

    return next.handle()
  }

  private generateKey(request: any): string {
    const { method, url, body, headers } = request
    // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ç”Ÿæˆé”®çš„é€»è¾‘
    return `idempotence:${method}:${url}:${JSON.stringify(body)}:${headers['user-id']}`
  }
}
```

*   è¿™ä¸ªæ‹¦æˆªå™¨ä¼šæ ¹æ®è¯·æ±‚çš„ç‰¹å¾ï¼ˆæ–¹æ³•ã€URLã€è¯·æ±‚ä½“ã€ç”¨æˆ· IDï¼‰ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„é”®ï¼Œå¹¶å°è¯•å°†å…¶å­˜å‚¨åˆ° Redis ä¸­ã€‚å¦‚æœåœ¨ä¸€å®šæ—¶é—´å†…ï¼ˆä¾‹å¦‚ 5 ç§’ï¼‰å‘ç°äº†ç›¸åŒçš„é”®ï¼Œåˆ™é˜»æ­¢è¯¥è¯·æ±‚ï¼Œå¹¶è¿”å›"è¯·å‹¿é‡å¤æäº¤"çš„é”™è¯¯ã€‚

## ğŸŒ å¸¸è§ Web å®‰å…¨é˜²æŠ¤

### 1. CORS (è·¨åŸŸèµ„æºå…±äº«)

CORS æœºåˆ¶å…è®¸ Web åº”ç”¨æœåŠ¡å™¨è¿›è¡Œè·¨åŸŸè®¿é—®æ§åˆ¶ã€‚`nest-admin` é¡¹ç›®åœ¨ `src/main.ts` ä¸­é…ç½®äº† CORSã€‚

```typescript
// src/main.ts
// ... existing code ...
app.enableCors({
  origin: '*', // å…è®¸æ‰€æœ‰æ¥æºï¼Œç”Ÿäº§ç¯å¢ƒåº”é…ç½®ä¸ºå…·ä½“åŸŸå
  credentials: true, // å…è®¸å‘é€ Cookie
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'], // å…è®¸çš„ HTTP æ–¹æ³•
  allowedHeaders: ['Content-Type', 'Authorization', 'Accept'], // å…è®¸çš„è¯·æ±‚å¤´
})
// ... existing code ...
```

*   åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ`origin` åº”è¯¥é…ç½®ä¸ºä½ çš„å‰ç«¯åº”ç”¨çš„å…·ä½“åŸŸåï¼Œè€Œä¸æ˜¯ `*`ï¼Œä»¥å¢å¼ºå®‰å…¨æ€§ã€‚

### 2. XSS (è·¨ç«™è„šæœ¬æ”»å‡»)

XSS æ”»å‡»é€šè¿‡æ³¨å…¥æ¶æ„è„šæœ¬æ¥çªƒå–ç”¨æˆ·æ•°æ®æˆ–åŠ«æŒç”¨æˆ·ä¼šè¯ã€‚NestJS æ¡†æ¶æœ¬èº«æä¾›äº†å¯¹è¾“å…¥æ•°æ®çš„å¤„ç†ï¼Œç»“åˆå‰ç«¯çš„ XSS é˜²æŠ¤åº“ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢ XSS æ”»å‡»ã€‚

*   **è¾“å‡ºç¼–ç **ï¼šåœ¨å‰ç«¯æ¸²æŸ“æ•°æ®æ—¶ï¼Œå¯¹æ‰€æœ‰æ¥è‡ªç”¨æˆ·è¾“å…¥æˆ–å¤–éƒ¨æ¥æºçš„æ•°æ®è¿›è¡Œ HTML å®ä½“ç¼–ç ï¼Œä»¥é˜²æ­¢æµè§ˆå™¨å°†æ¶æ„è„šæœ¬è§£æä¸ºå¯æ‰§è¡Œä»£ç ã€‚
*   **å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)**ï¼šé€šè¿‡ HTTP å“åº”å¤´ `Content-Security-Policy` æ¥é™åˆ¶é¡µé¢å¯ä»¥åŠ è½½çš„èµ„æºï¼Œä»è€Œé™ä½ XSS æ”»å‡»çš„é£é™©ã€‚

### 3. CSRF (è·¨ç«™è¯·æ±‚ä¼ªé€ )

CSRF æ”»å‡»è¯±å¯¼ç”¨æˆ·åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å‘é€æ¶æ„è¯·æ±‚ã€‚NestJS å¯ä»¥é›†æˆ CSRF é˜²æŠ¤åº“æ¥ç”Ÿæˆå’ŒéªŒè¯ CSRF Tokenã€‚

*   é€šå¸¸ä½¿ç”¨ `csurf` åº“ç”Ÿæˆå’ŒéªŒè¯ CSRF Tokenï¼Œåœ¨æ¯ä¸ªé GET è¯·æ±‚ä¸­æºå¸¦ CSRF Token è¿›è¡ŒéªŒè¯ã€‚

## ğŸ“Š å®‰å…¨æ—¥å¿—ä¸ç›‘æ§

è®°å½•å®‰å…¨ç›¸å…³çš„æ—¥å¿—å¹¶è¿›è¡Œç›‘æ§æ˜¯å‘ç°å’Œå“åº”å®‰å…¨äº‹ä»¶çš„å…³é”®ã€‚`nest-admin` é¡¹ç›®ä¸­çš„æ—¥å¿—æ¨¡å—å¯ä»¥è®°å½•ç™»å½•å¤±è´¥ã€æƒé™æ‹’ç»ã€å¼‚å¸¸ç­‰å…³é”®å®‰å…¨äº‹ä»¶ã€‚

*   **ç™»å½•æ—¥å¿—**ï¼šè®°å½•ç”¨æˆ·çš„ç™»å½•å°è¯•ï¼ŒåŒ…æ‹¬æˆåŠŸå’Œå¤±è´¥çš„ç™»å½•ã€IP åœ°å€ã€è®¾å¤‡ä¿¡æ¯ç­‰ã€‚
*   **æ“ä½œæ—¥å¿—**ï¼šè®°å½•ç”¨æˆ·å¯¹ç³»ç»Ÿèµ„æºçš„ä¿®æ”¹æ“ä½œï¼Œä¾‹å¦‚åˆ›å»ºç”¨æˆ·ã€åˆ é™¤æ–‡ç« ç­‰ã€‚
*   **å¼‚å¸¸æ—¥å¿—**ï¼šè®°å½•ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„å¼‚å¸¸ï¼Œç‰¹åˆ«æ˜¯ä¸å®‰å…¨ç›¸å…³çš„å¼‚å¸¸ï¼ˆå¦‚è®¤è¯å¤±è´¥ã€æƒé™ä¸è¶³ï¼‰ã€‚
*   **ç›‘æ§å‘Šè­¦**ï¼šç»“åˆç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ Prometheusã€Grafanaï¼‰ï¼Œå¯¹å…³é”®å®‰å…¨æŒ‡æ ‡ï¼ˆå¦‚å¼‚å¸¸ç™»å½•æ¬¡æ•°ã€è¢«æ‹’ç»è¯·æ±‚æ•°ï¼‰è®¾ç½®å‘Šè­¦ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸è¡Œä¸ºã€‚

## âœ¨ æœ€ä½³å®è·µæ€»ç»“

*   **çºµæ·±é˜²å¾¡**ï¼šä¸è¦ä¾èµ–å•ä¸€çš„å®‰å…¨æªæ–½ï¼Œè€Œæ˜¯ä»å¤šä¸ªå±‚é¢ï¼ˆè®¤è¯ã€æˆæƒã€è¾“å…¥éªŒè¯ã€é™æµã€ä¼ è¾“å®‰å…¨ç­‰ï¼‰è¿›è¡Œé˜²å¾¡ã€‚
*   **æœ€å°æƒé™åŸåˆ™**ï¼šç”¨æˆ·å’Œåº”ç”¨ç¨‹åºåªè¢«æˆäºˆå®Œæˆå…¶ä»»åŠ¡æ‰€éœ€çš„æœ€å°æƒé™ã€‚
*   **æŒç»­æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°æ‰€æœ‰ä¾èµ–åº“å’Œæ¡†æ¶ï¼Œä»¥ä¿®å¤å·²çŸ¥çš„å®‰å…¨æ¼æ´ã€‚
*   **å®‰å…¨å®¡è®¡**ï¼šå®šæœŸè¿›è¡Œä»£ç å®‰å…¨å®¡è®¡å’Œæ¸—é€æµ‹è¯•ï¼Œå‘ç°æ½œåœ¨çš„å®‰å…¨é—®é¢˜ã€‚
*   **å®‰å…¨æ„è¯†**ï¼šå¼€å‘è€…åº”å…·å¤‡åŸºæœ¬çš„å®‰å…¨ç¼–ç æ„è¯†ï¼Œé¿å…å¼•å…¥å¸¸è§çš„å®‰å…¨æ¼æ´ã€‚

é€šè¿‡ä»¥ä¸Šè¿™äº›å®‰å…¨å®è·µï¼Œ`nest-admin` é¡¹ç›®è‡´åŠ›äºä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªå®‰å…¨ã€ç¨³å®šçš„è¿è¡Œç¯å¢ƒã€‚
